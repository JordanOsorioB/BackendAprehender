generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Student {
  id                String                   @id @default(cuid())
  nombre            String
  level             Int
  experience        Int
  profileType       ProfileType              @default(STUDENT)
  courseEnrollments CourseEnrollment[]
  exerciseStates    ExerciseState[]
  subjectProgress   StudentSubjectProgress[]
  unitProgress      StudentUnitProgress[]
  user              User?
}

model CourseEnrollment {
  id        String   @id @default(cuid())
  studentId String
  courseId  String
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id])
}

model School {
  id       String    @id @default(cuid())
  name     String
  courses  Course[]
  teachers Teacher[]
  users    User[]    @relation("UserToSchool")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  schoolId  String?
  role      UserRole @default(STUDENT)
  studentId String?  @unique
  teacherId String?  @unique
  username  String   @unique @default("nickname")
  school    School?  @relation("UserToSchool", fields: [schoolId], references: [id])
  student   Student? @relation(fields: [studentId], references: [id])
  teacher   Teacher? @relation(fields: [teacherId], references: [id])
}

model Teacher {
  id          String      @id @default(cuid())
  name        String
  subjectId   String
  schoolId    String
  profileType ProfileType @default(TEACHER)
  courses     Course[]
  school      School      @relation(fields: [schoolId], references: [id])
  subject     Subject     @relation(fields: [subjectId], references: [id])
  user        User?
}

model Subject {
  id              String                   @id @default(cuid())
  name            String
  studentProgress StudentSubjectProgress[]
  units           SubjectUnit[]
  teachers        Teacher[]
}

model Course {
  id          String             @id @default(cuid())
  name        String
  schoolId    String
  teacherId   String
  school      School             @relation(fields: [schoolId], references: [id])
  teacher     Teacher            @relation(fields: [teacherId], references: [id])
  enrollments CourseEnrollment[]
  progress    Progress[]
}

model Progress {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id])
}

model SubjectUnit {
  id           Int                   @id @default(autoincrement())
  title        String
  description  String
  order        Int
  subjectId    String
  unitId       Int
  exercises    Exercise[]
  unitProgress StudentUnitProgress[] @relation("ProgressToSubjectUnit")
  subject      Subject               @relation(fields: [subjectId], references: [id])
  unit         Unit                  @relation("UnitSubjectUnits", fields: [unitId], references: [id])
}

model Exercise {
  id               String            @id @default(cuid())
  title            String
  description      String
  type             ExerciseType
  difficulty       String
  totalExperience  Int
  subjectUnitId    Int
  content          Json
  subjectUnit      SubjectUnit       @relation(fields: [subjectUnitId], references: [id])
  exerciseContents ExerciseContent[]
  states           ExerciseState[]
}

model ExerciseState {
  id               String   @id @default(cuid())
  studentId        String
  exerciseId       String
  completed        Boolean
  attempts         Int
  lastAttempt      DateTime
  correctAnswers   Int
  experienceEarned Int
  locked           Boolean
  respuesta        String?
  exercise         Exercise @relation(fields: [exerciseId], references: [id])
  student          Student  @relation(fields: [studentId], references: [id])
}

model StudentSubjectProgress {
  id        String  @id @default(cuid())
  studentId String
  subjectId String
  progress  Int
  student   Student @relation(fields: [studentId], references: [id])
  subject   Subject @relation(fields: [subjectId], references: [id])
}

model StudentUnitProgress {
  id          String      @id @default(cuid())
  studentId   String
  unitId      Int
  unitFkId    Int
  progress    Int
  student     Student     @relation(fields: [studentId], references: [id])
  unit        Unit        @relation("ProgressToUnit", fields: [unitFkId], references: [id])
  subjectUnit SubjectUnit @relation("ProgressToSubjectUnit", fields: [unitId], references: [id])
}

model Unit {
  id                 Int                   @id @default(autoincrement())
  title              String
  description        String
  order              Int
  developmentContent DevelopmentContent[]
  levels             Level[]
  unitProgress       StudentUnitProgress[] @relation("ProgressToUnit")
  subjectUnits       SubjectUnit[]         @relation("UnitSubjectUnits")
}

model Level {
  id           Int           @id @default(autoincrement())
  name         String
  description  String?
  order        Int
  unitId       Int
  unit         Unit          @relation(fields: [unitId], references: [id])
  pairingPairs PairingPair[]
}

model PairingPair {
  id              Int              @id @default(autoincrement())
  name            String
  description     String?
  levelId         Int
  pairingContents PairingContent[]
  level           Level            @relation(fields: [levelId], references: [id])
}

model PairingContent {
  id            Int         @id @default(autoincrement())
  content       String
  pairingPairId Int
  pairingPair   PairingPair @relation(fields: [pairingPairId], references: [id])
}

model DevelopmentContent {
  id          Int     @id @default(autoincrement())
  title       String
  description String?
  content     String
  unitId      Int
  unit        Unit    @relation(fields: [unitId], references: [id])
}

model ExerciseContent {
  id           Int                 @id @default(autoincrement())
  content      Json
  exerciseId   String
  alternatives AlternativeOption[]
  exercise     Exercise            @relation(fields: [exerciseId], references: [id])
}

model AlternativeOption {
  id                  Int                  @id @default(autoincrement())
  text                String
  isCorrect           Boolean
  exerciseContentId   Int
  alternativeContents AlternativeContent[]
  exerciseContent     ExerciseContent      @relation(fields: [exerciseContentId], references: [id])
}

model AlternativeContent {
  id                  Int               @id @default(autoincrement())
  description         String
  alternativeOptionId Int
  alternativeOption   AlternativeOption @relation(fields: [alternativeOptionId], references: [id])
}

enum ExerciseType {
  alternativas
  desarrollo
  terminos_pareados
}

enum UserRole {
  UTP
  TEACHER
  STUDENT
  ADMIN
  SUPERADMIN
}
enum ProfileType {
  UTP
  TEACHER
  STUDENT
}
